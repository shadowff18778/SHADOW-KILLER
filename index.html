<!DOCTYPE html>
<html lang="fr" oncontextmenu="return false;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHADOW KILLER</title>
    <!-- Use Tailwind CSS for modern and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the console theme and glitch effect */
        html, body {
            height: 100%;
            font-family: 'VT323', monospace;
            background-color: #000000;
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='48' viewport='0 0 100 100' style='fill:white;font-size:24px;'><text y='50%'>üíÄ</text></svg>") 16 16, auto;
            overflow: hidden; /* Prevents global page scrolling */
        }

        /* Scanline effect to simulate a CRT screen (optional) */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 1px,
                rgba(255, 255, 255, 0.05) 1px,
                rgba(255, 255, 255, 0.05) 2px
            );
            z-index: 100;
        }

        /* Glitch animation for text */
        @keyframes text-glitch {
            0% { transform: translate(0); opacity: 1; }
            20% { transform: translate(-2px, -2px); opacity: 0.8; }
            40% { transform: translate(2px, 2px); opacity: 1; }
            60% { transform: translate(-1px, 1px); opacity: 0.9; }
            80% { transform: translate(1px, -1px); opacity: 1; }
            100% { transform: translate(0); opacity: 1; }
        }

        .glitch-text {
            animation: text-glitch 0.5s infinite alternate;
        }
        
        /* Shake animation for the entire pop-up */
        @keyframes popup-shake {
            0% { transform: translate(-50%, -50%); }
            20% { transform: translate(-52%, -48%); }
            40% { transform: translate(-48%, -52%); }
            60% { transform: translate(-51%, -49%); }
            80% { transform: translate(-49%, -51%); }
            100% { transform: translate(-50%, -50%); }
        }

        /* Flicker animation for an interference effect */
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .flicker {
            animation: flicker 0.2s infinite alternate;
        }

        /* Blinking effect for the red dot to alternate between colors */
        @keyframes blink-color {
            0%, 100% { background-color: #ff0000; }
            50% { background-color: #000000; }
        }
        
        .blinking-dot {
            animation: blink-color 1s infinite;
        }
        
        /* Alert bar at the top, red with a border */
        .alert-bar {
            background-color: #8b0000;
            border-bottom: 2px solid #ff0000;
        }

        /* Hacking pop-up in the center */
        .hacking-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff0000;
            box-shadow: 0 0 10px #ff0000;
            z-index: 200;
            display: none;
            animation: popup-shake 0.1s infinite alternate, flicker 0.3s infinite alternate;
        }

        .hacking-popup-bar {
            width: 100%;
            height: 5px;
            background: #440000;
            margin-top: 1rem;
            overflow: hidden;
        }

        .hacking-popup-progress {
            height: 100%;
            background-color: #ff0000;
            transition: width linear;
        }

        /* Pop-up for the access code */
        .code-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff0000;
            box-shadow: 0 0 10px #ff0000;
            z-index: 300;
            display: none;
            text-align: center;
            animation: popup-shake 0.1s infinite alternate, flicker 0.3s infinite alternate;
        }

        .code-popup input {
            background-color: transparent;
            border-bottom: 2px solid #ff0000;
            color: #ff0000;
            font-size: 1.5rem;
            padding: 0.5rem;
            outline: none;
            text-align: center;
        }
        .code-popup p {
            font-size: 1.2rem;
            color: #ff0000;
        }
        
        .close-button {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 1.5rem;
            line-height: 1;
            color: #ff0000;
            cursor: pointer;
        }

        /* Hide screens at the start */
        #start-screen, #loading-screen, #main-content {
            display: none;
            position: absolute;
            inset: 0;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Show start screen on load */
        #start-screen.active {
            display: flex;
        }

        /* Custom video player style */
        .custom-video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: none;
            display: block;
        }
        
        /* Custom video controls overlay */
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-top: 2px solid #ff0000;
            transition: opacity 0.3s ease-in-out;
        }

        /* Class to hide controls with opacity 0 */
        .video-controls.controls-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .play-pause-btn, .fullscreen-btn {
            font-size: 1.5rem;
            color: #ff0000;
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            width: 3rem;
            text-align: center;
            line-height: 1;
        }

        .progress-bar-container {
            flex-grow: 1;
            height: 5px;
            background: #440000;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: #ff0000;
            transition: width 0.1s linear;
        }

        .time-display {
            font-size: 0.8rem;
            color: #ff0000;
            margin-left: 0.5rem;
            width: 5rem;
            text-align: right;
        }

        /* Style for custom fullscreen mode */
        .custom-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999;
            background: black;
            border: 2px solid #ff0000;
        }
        
        /* Video lock overlay */
        .video-lock-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #ff0000;
            font-size: 1.5rem;
            text-align: center;
            z-index: 10;
        }
        
        /* Unlock Loading Overlay */
        #unlock-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 400;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Animation for the progress bar */
        @keyframes load-progress {
            0% { width: 0; }
            100% { width: 100%; }
        }
        
        .loading-progress-bar {
            width: 50%;
            height: 4px;
            background-color: #440000;
            margin-top: 1rem;
            overflow: hidden;
        }
        
        .loading-progress-bar div {
            height: 100%;
            background-color: #ff0000;
            animation: load-progress 3s linear forwards;
        }
        
        /* Updated animation for the "Powered by SHADOW" text */
        @keyframes shadow-text-flicker {
            0%, 100% { 
                opacity: 1;
                /* Subtler text shadow for a less intense neon effect */
                text-shadow: 0 0 2px #ff0000, 0 0 5px #ff0000; 
            }
            50% { 
                opacity: 0.8;
                text-shadow: none; /* No shadow at midpoint for the flicker effect */
            }
        }
        
        .shadow-text {
            color: #ff0000;
            font-size: 1rem;
            animation: shadow-text-flicker 1.5s infinite alternate;
        }

        /* NEW: Stylized message for video not found */
        .video-error-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ff0000;
            font-size: 1.5rem;
            text-align: center;
            z-index: 10;
        }
        
        /* Animation for the error icon */
        @keyframes pulse-error {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .video-error-overlay .error-icon {
            animation: pulse-error 1.5s infinite;
            font-size: 4rem;
        }
        
    </style>
</head>
<body class="bg-black text-white flex flex-col h-full">

    <!-- Start screen -->
    <div id="start-screen" class="w-full h-full bg-black z-10 active">
        <h1 class="text-3xl text-red-600 mb-8 glitch-text">
            [D√âMARRAGE DU TERMINAL]
        </h1>
        <button id="startButton" class="bg-transparent border-2 border-red-600 text-red-600 px-8 py-4 text-xl hover:bg-red-600 hover:text-black transition-colors glitch-text">
            COMMENCER
        </button>
    </div>

    <!-- Loading screen (hidden at start) -->
    <div id="loading-screen" class="w-full h-full bg-black z-20">
        <p class="text-xl text-red-600 flicker">
            BOOTING...
        </p>
        <!-- NEW: "Powered by SHADOW" text with animation -->
        <p class="shadow-text absolute bottom-4">
            Powered by SHADOW
        </p>
    </div>

    <!-- Main content (hidden at start) -->
    <div id="main-content" class="w-full flex-1 flex flex-col p-4 hidden">
        <!-- Alert bar at the top -->
        <div class="alert-bar text-sm sm:text-base p-2 flex justify-between items-center text-red-300 flex-shrink-0">
            <span class="glitch-text text-xl text-red-500">SHADOW KILLER</span>
            <!-- User count has been moved -->
            <span class="glitch-text text-xl text-red-500"></span>
        </div>

        <!-- Main section with video and chat -->
        <div class="flex-1 flex flex-col sm:flex-row gap-4 mt-4 overflow-hidden min-h-0">
            <!-- Video container, takes up space -->
            <div id="video-wrapper" class="w-full sm:w-2/3 flex-shrink-0 flex items-center justify-center bg-black relative aspect-video border-2 border-red-600">
                <!-- Custom video player -->
                <div class="custom-video-container w-full h-full">
                    <video id="video-player"></video>
                    
                    <!-- Interface for loading and error -->
                    <div id="video-status" class="absolute inset-0 bg-black flex items-center justify-content-center text-red-600 text-lg">
                        <p id="video-status-text" class="glitch-text">TENTATIVE DE CONNEXION AU FLUX VID√âO...</p>
                    </div>
                    
                    <!-- Video lock overlay -->
                    <div id="video-lock-overlay" class="video-lock-overlay">
                        <p class="glitch-text mb-4">[ACC√àS VID√âO VERROUILL√â]</p>
                        <button id="unlockVideoButton" class="bg-red-600 text-black font-bold p-2 mt-4 glitch-text">
                            D√âVERROUILLER LA VID√âO
                        </button>
                    </div>

                    <!-- NEW: Video error overlay -->
                    <div id="video-error-overlay" class="video-error-overlay">
                        <span class="error-icon mb-4">‚ò†</span>
                        <p class="glitch-text text-2xl">[VID√âO INACCESSIBLE]</p>
                        <p class="text-sm mt-2 text-gray-400">Le flux vid√©o n'est pas disponible pour le moment.</p>
                    </div>

                    <!-- Video player controls -->
                    <div id="video-controls" class="video-controls controls-hidden glitch-text">
                        <button id="play-pause-btn" class="play-pause-btn glitch-text" disabled>‚ñ∂</button>
                        <div id="progress-bar-container" class="progress-bar-container">
                            <div id="progress-bar" class="progress-bar"></div>
                        </div>
                        <span id="time-display" class="time-display">00:00 / 00:00</span>
                        <button id="fullscreen-btn" class="fullscreen-btn glitch-text">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 inline-block">
                                <path fill-rule="evenodd" d="M3 3.75A.75.75 0 013.75 3h4.5a.75.75 0 010 1.5h-3v3a.75.75 0 01-1.5 0v-4.5zm12 0a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-3v3a.75.75 0 01-1.5 0v-4.5zM3 15.75a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-3v3a.75.75 0 01-1.5 0v-4.5zm12 0a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-3v3a.75.75 0 01-1.5 0v-4.5z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat container, takes remaining space and scrolls -->
            <div class="w-full sm:w-1/3 flex-1 flex flex-col bg-black border-2 border-red-600 min-h-0">
                <!-- NEW: user counter is now inside this heading with a blinking dot -->
                <h2 class="bg-red-600 text-black text-center text-lg p-2 font-bold flicker flex justify-between items-center px-4 flex-shrink-0">
                    <span>MESSAGES EN DIRECT</span>
                    <span class="flex items-center gap-1 text-sm">
                        <!-- Updated color for the blinking dot and text -->
                        <span class="w-2 h-2 rounded-full blinking-dot"></span>
                        <span id="user-count" class="flicker text-black">1</span>
                    </span>
                </h2>
                <!-- Scrollable message area -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-2 text-red-300">
                    <!-- Initial chat messages to build atmosphere -->
                    <p class="flicker"><span class="text-red-500">SYSTEM:</span> Connexion au terminal √©tablie...</p>
                    <p class="flicker"><span class="text-red-500">SYSTEM:</span> Attention, surveillance d√©tect√©e. Votre anonymat est en danger.</p>
                </div>
                <!-- Chat input and button (fixed) -->
                <div class="flex-shrink-0 mt-auto">
                    <div id="chat-input-container" class="mt-2 p-2 locked">
                        <input type="text" id="messageInput" placeholder="> COMMENCER PAR D√âVERROUILLER LE CHAT..." class="w-full bg-transparent text-red-600 border-b border-red-600 placeholder-red-800 focus:outline-none">
                    </div>
                    <button id="unlockChatButton" class="w-full bg-red-600 text-black font-bold p-2 mt-2 glitch-text">
                        D√âVERROUILLER LE CHAT
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scary IP pop-up -->
    <div id="scary-popup" class="hacking-popup">
        <h3 id="popup-text" class="text-lg text-red-500 text-center glitch-text">
            R√âCUP√âRATION DES DONN√âES...
        </h3>
        <div class="hacking-popup-bar">
            <div id="popup-loading-bar" class="hacking-popup-progress"></div>
        </div>
    </div>

    <!-- Pop-up for the access code -->
    <div id="code-popup" class="code-popup">
        <span class="close-button" id="closeCodePopup">&times;</span>
        <h3 class="text-lg text-red-500 glitch-text mb-4">
            [ACC√àS REQUIS]
        </h3>
        <p class="text-red-300 mb-2">ENTREZ LE CODE D'ACC√àS POUR CONTINUER:</p>
        <input type="password" id="codeInput" maxlength="6">
        <p id="codeError" class="text-red-600 mt-2 hidden">CODE INCORRECT.</p>
        <button id="submitCodeButton" class="bg-red-600 text-black font-bold p-2 mt-4 glitch-text">
            SOUMETTRE
        </button>
    </div>
    
    <!-- Unlock Loading Overlay -->
    <div id="unlock-loading-overlay" class="glitch-text" style="display: none;">
        <h3 id="unlock-loading-text" class="text-3xl text-red-600 text-center glitch-text"></h3>
        <div class="loading-progress-bar">
            <div></div>
        </div>
    </div>

    <!-- Script for site logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startScreen = document.getElementById('start-screen');
            const loadingScreen = document.getElementById('loading-screen');
            const mainContent = document.getElementById('main-content');
            const startButton = document.getElementById('startButton');
            const messageInput = document.getElementById('messageInput');
            const chatMessages = document.getElementById('chatMessages');
            const scaryPopup = document.getElementById('scary-popup');
            const popupLoadingBar = document.getElementById('popup-loading-bar');
            const unlockChatButton = document.getElementById('unlockChatButton');
            const chatInputContainer = document.getElementById('chat-input-container');
            const codePopup = document.getElementById('code-popup');
            const codeInput = document.getElementById('codeInput');
            const submitCodeButton = document.getElementById('submitCodeButton');
            const codeError = document.getElementById('codeError');
            const closeCodePopup = document.getElementById('closeCodePopup');
            const userCountDisplay = document.getElementById('user-count'); // Element to display the user count
            
            // NEW: Elements for the new loading animation
            const unlockLoadingOverlay = document.getElementById('unlock-loading-overlay');
            const unlockLoadingText = document = document.getElementById('unlock-loading-text');

            // Video player elements
            const videoWrapper = document.getElementById('video-wrapper');
            const videoPlayer = document.getElementById('video-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const progressBar = document.getElementById('progress-bar');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const timeDisplay = document.getElementById('time-display');
            const videoStatus = document.getElementById('video-status');
            const videoStatusText = document.getElementById('video-status-text');
            const videoControls = document.getElementById('video-controls');
            const videoLockOverlay = document.getElementById('video-lock-overlay');
            const unlockVideoButton = document.getElementById('unlockVideoButton');

            // NEW: Video error overlay
            const videoErrorOverlay = document.getElementById('video-error-overlay');

            const CHAT_ACCESS_CODE = "95741";
            const VIDEO_ACCESS_CODE = "95741"; 
            let userIp = null;
            let popupsQueue = [];
            let isProcessingPopup = false;
            let controlsHideTimeout = null;
            let userCountInterval = null;

            // Updated list of SYSTEM messages to be more unsettling.
            const chatMessagesList = [
                "SYSTEM: Anomalie d√©tect√©e dans le flux de donn√©es.",
                "SYSTEM: Erreur de checksum. Donn√©es corrompues.",
                "SYSTEM: Vous n'auriez pas d√ª venir ici...",
                "SYSTEM: Avertissement: la connexion est instable. La ligne a √©t√© compromise.",
                "SYSTEM: Le serveur r√©pond mais ne renvoie rien... Une pr√©sence inconnue?",
                "SYSTEM: Je vois... ton visage...",
                "SYSTEM: Une entit√© se connecte au terminal. Nom: inconnue.",
                "SYSTEM: Je n'arrive plus √† bouger ma souris... mon curseur est √† l'envers",
                "SYSTEM: L'appareil n'est plus sous votre contr√¥le.",
                "SYSTEM: Vous allez regretter d'√™tre entr√© sur ce serveur.",
                "SYSTEM: Les pare-feu ont √©chou√©. Acc√®s total accord√©...",
                "SYSTEM: Il n'y a personne d'autre ici que nous.",
                "SYSTEM: ... et toi.",
                "SYSTEM: On te voit...",
                "SYSTEM: Bient√¥t, tu seras l'un des n√¥tres.",
                "SYSTEM: Traces num√©riques laiss√©es... Impossible de les effacer.",
                "SYSTEM: Votre identit√© a √©t√© compromise. Ce n'est qu'une question de temps.",
                "SYSTEM: La boucle est ouverte. Il n'y a plus d'√©chappatoire.",
                "SYSTEM: Les signaux s'affaiblissent. Ils approchent...",
                "SYSTEM: Le chaos s'installe. Pr√©paration √† l'√©v√©nement de purge.",
                "SYSTEM: Les derni√®res connexions ont √©t√© corrompues.",
                "SYSTEM: Ne faites pas de bruit, ils peuvent vous entendre √† travers la ligne.",
                "SYSTEM: Le dernier utilisateur est parti. Non, il a √©t√© d√©connect√© de force.",
                "SYSTEM: La r√©alit√© virtuelle se d√©compose... Un autre monde se superpose.",
                "SYSTEM: Votre connexion n'est pas s√©curis√©e. Ils connaissent votre localisation exacte."
            ];

            const fakeUsernames = [
                "ANONYME-51A", "USER-23B", "GHOST-7C", "SHADOW-10D", "CYPHER-9E", "GLITCH-11F", 
                "REVENANT-14G", "ECHO-2H", "VOID-15I", "SPECTRE-8J", "MALWARE-6K", "VIRUS-12L"
            ];

            // Updated list of fake user messages to be more specific and urgent
            const fakeUserMessages = [
                "C'est quoi ce truc?",
                "Ma souris bouge toute seule...",
                "Quelqu'un d'autre voit √ßa ?",
                "J'ai peur...",
                "On dirait qu'on est pi√©g√©s.",
                "La vid√©o ne marche pas !",
                "Y a quelqu'un ?",
                "La lumi√®re clignote chez moi.",
                "Je crois qu'on m'observe...",
                "Cette page est bizarre...",
                "Qui a mis √ßa en ligne ?",
                "Je n'arrive pas √† sortir.",
                "Mon clavier ne r√©pond plus.",
                "Je vois un visage...",
                "Fermez la fen√™tre !",
                "Je n'aurais jamais d√ª me connecter.",
                // New messages added here as requested
                "Il faut quitter ce site, ils volent nos informations !",
                "Mon antivirus a sonn√©, c'est pas bon signe.",
                "Utilisez un VPN les gars ! On est en danger !",
                "S'il vous pla√Æt, quelqu'un, faites quelque chose !",
                "Je ne vois plus mon curseur, c'est bloqu√©.",
                "Ne donnez aucune info, ils enregistrent tout.",
                "Je viens de voir une notification de transaction bizarre...",
                "Il y a un bruit bizarre qui vient de l'int√©rieur de l'ordinateur...",
                "Je crois qu'ils ont un acc√®s direct √† ma cam√©ra."
            ];

            let lastMessageIndex = -1;
            let lastFakeUserIndex = -1;

            // Generate a fake IP in case of fetch failure
            function generateFakeIp() {
                return `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
            }

            // Fetch user's public IP
            async function getPublicIp() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return data.ip;
                } catch (error) {
                    console.error("Error fetching IP, using a fake one.", error);
                    return generateFakeIp();
                }
            }

            // Add a random SYSTEM message
            function addRandomSystemMessage() {
                let messageIndex = lastMessageIndex;
                while (messageIndex === lastMessageIndex) {
                    messageIndex = Math.floor(Math.random() * chatMessagesList.length);
                }
                lastMessageIndex = messageIndex;

                const message = chatMessagesList[messageIndex];
                const parts = message.split(':');
                const sender = parts.shift();
                const text = parts.join(':').trim();
                const newMessage = document.createElement('p');
                newMessage.classList.add('flicker');
                newMessage.innerHTML = `<span class="text-red-500">${sender}:</span> <span class="text-red-300">${text}</span>`;
                
                chatMessages.appendChild(newMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                const randomDelay = Math.random() * 2000 + 1000;
                setTimeout(addRandomSystemMessage, randomDelay);
            }
            
            // Add a random fake user message to the chat
            function addFakeUserMessage() {
                let userIndex = lastFakeUserIndex;
                let messageIndex = Math.floor(Math.random() * fakeUserMessages.length);
                
                // Ensure a different user and message are selected
                while (userIndex === lastFakeUserIndex) {
                    userIndex = Math.floor(Math.random() * fakeUsernames.length);
                }
                lastFakeUserIndex = userIndex;

                const username = fakeUsernames[userIndex];
                const message = fakeUserMessages[messageIndex];
                
                const newMessage = document.createElement('p');
                newMessage.classList.add('flicker');
                newMessage.innerHTML = `<span class="text-white">${username}:</span> <span class="text-red-300">${message}</span>`;
                
                chatMessages.appendChild(newMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                const randomDelay = Math.random() * 3000 + 1500; // Fake users respond a bit slower
                setTimeout(addFakeUserMessage, randomDelay);
            }

            // Function to update the fake user count
            function updateFakeUserCount() {
                const minUsers = 13;
                const maxUsers = 27;
                const userCount = Math.floor(Math.random() * (maxUsers - minUsers + 1)) + minUsers;
                userCountDisplay.textContent = `${userCount}`;
            }

            // Show scary IP pop-up
            function showScaryPopup() {
                scaryPopup.style.display = 'block';
                popupLoadingBar.style.width = '0%';
                setTimeout(() => {
                    popupLoadingBar.style.width = '100%';
                    // UPDATED: Duration to 2 seconds
                    popupLoadingBar.style.transition = 'width 2s linear';
                }, 100);

                setTimeout(() => {
                    scaryPopup.style.display = 'none';
                    addIpMessageToChat(userIp);
                }, 2000); // UPDATED: Duration to 2 seconds
            }

            // Add an IP message to the chat
            function addIpMessageToChat(ip) {
                const newMessage = document.createElement('p');
                newMessage.classList.add('flicker');
                newMessage.innerHTML = `<span class="text-red-500">SYSTEM:</span> <span class="text-red-300">Adresse IP d√©tect√©e: <span class="text-white">${ip}</span></span>`;
                chatMessages.appendChild(newMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Functions to manage hacking pop-ups
            function createHackingPopup(title, duration) {
                const popup = document.createElement('div');
                popup.classList.add('hacking-popup', 'glitch-text');

                const titleElement = document.createElement('h3');
                titleElement.classList.add('text-lg', 'text-red-500', 'text-center');
                titleElement.textContent = `[${title}]`;

                const barContainer = document.createElement('div');
                barContainer.classList.add('hacking-popup-bar');

                const progressBar = document.createElement('div');
                progressBar.classList.add('hacking-popup-progress');

                barContainer.appendChild(progressBar);
                popup.appendChild(titleElement);
                popup.appendChild(barContainer);

                document.body.appendChild(popup);
                popup.style.display = 'block';

                setTimeout(() => {
                    progressBar.style.width = '100%';
                    progressBar.style.transition = `width ${duration}ms linear`;
                }, 50);

                return new Promise(resolve => {
                    setTimeout(() => {
                        popup.remove();
                        resolve();
                    }, duration);
                });
            }

            async function processPopupQueue() {
                if (isProcessingPopup || popupsQueue.length === 0) {
                    return;
                }

                isProcessingPopup = true;
                const nextPopup = popupsQueue.shift();
                await createHackingPopup(nextPopup.title, nextPopup.duration);
                isProcessingPopup = false;
                processPopupQueue(); // Process the next pop-up
            }

            // Video player functions
            function formatTime(time) {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            // Function to toggle play/pause
            function togglePlayPause() {
                if (videoPlayer.paused || videoPlayer.ended) {
                    videoPlayer.play();
                } else {
                    videoPlayer.pause();
                }
            }

            // Function to seek 10 seconds forward or backward
            function seek(seconds) {
                videoPlayer.currentTime += seconds;
            }
            
            // --- NEW LOGIC FOR VIDEO PLAYER CONTROLS V4 ---
            function showControls() {
                videoControls.classList.remove('controls-hidden');
            }

            function hideControls() {
                videoControls.classList.add('controls-hidden');
            }
            
            function resetHideTimer() {
                clearTimeout(controlsHideTimeout);
                // Controls stay visible when video is paused
                if (!videoPlayer.paused) {
                    controlsHideTimeout = setTimeout(() => {
                        hideControls();
                    }, 3000); // Hide after 3 seconds of inactivity
                }
            }
            
            // Use a single mousemove listener on the wrapper
            videoWrapper.addEventListener('mousemove', () => {
                showControls();
                resetHideTimer();
            });

            // Use mouseleave only to clear the timer if the mouse leaves the entire video area
            videoWrapper.addEventListener('mouseleave', () => {
                clearTimeout(controlsHideTimeout);
                hideControls();
            });
            
            // Mobile events
            videoWrapper.addEventListener('touchstart', () => {
                showControls();
                resetHideTimer();
            }, { passive: true });

            videoWrapper.addEventListener('touchend', () => {
                resetHideTimer();
            }, { passive: true });


            // When video is playing, enable the hide timer
            videoPlayer.addEventListener('play', () => {
                playPauseBtn.textContent = '‚è∏';
                resetHideTimer();
            });

            // When video is paused, disable the hide timer and show controls
            videoPlayer.addEventListener('pause', () => {
                playPauseBtn.textContent = '‚ñ∂';
                showControls();
                clearTimeout(controlsHideTimeout);
            });

            // Handle button clicks
            playPauseBtn.addEventListener('click', () => {
                togglePlayPause();
            });

            videoPlayer.addEventListener('timeupdate', () => {
                const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                progressBar.style.width = `${progress}%`;
                timeDisplay.textContent = `${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
            });

            progressBarContainer.addEventListener('click', (e) => {
                const clickPosition = e.offsetX;
                const totalWidth = progressBarContainer.offsetWidth;
                const seekTime = (clickPosition / totalWidth) * videoPlayer.duration;
                videoPlayer.currentTime = seekTime;
            });
            
            // Hide status pop-up when video is ready to play
            videoPlayer.addEventListener('canplay', () => {
                videoStatus.style.display = 'none';
            });

            // Handle video loading errors
            videoPlayer.addEventListener('error', () => {
                videoStatus.style.display = 'flex';
                videoStatusText.textContent = "ERREUR DE CONNEXION AU FLUX...";
            });

            // Function for custom fullscreen mode
            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    videoWrapper.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
            
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            // UPDATED LOGIC FOR FULLSCREEN:
            // This function handles the transition between custom and native controls
            // when entering or exiting fullscreen mode.
            document.addEventListener('fullscreenchange', () => {
                if (document.fullscreenElement) {
                    // Entering fullscreen:
                    // 1. Hide the custom controls.
                    videoControls.style.display = 'none';
                    // 2. Add the 'controls' attribute to the video element to enable native controls.
                    videoPlayer.controls = true;
                    // 3. Apply custom fullscreen styling to the wrapper.
                    videoWrapper.classList.add('custom-fullscreen');
                    // 4. Hide the main content to make the video take up the entire screen.
                    document.getElementById('main-content').classList.add('hidden');
                } else {
                    // Exiting fullscreen:
                    // 1. Show the custom controls again.
                    videoControls.style.display = 'flex';
                    // 2. Remove the 'controls' attribute to hide native controls.
                    videoPlayer.controls = false;
                    // 3. Remove custom fullscreen styling from the wrapper.
                    videoWrapper.classList.remove('custom-fullscreen');
                    // 4. Show the main content again.
                    document.getElementById('main-content').classList.remove('hidden');
                }
            });


            // Keyboard event listener to block dev tools and control video
            document.addEventListener('keydown', (e) => {
                // Block dev tools shortcuts
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'J')) {
                    e.preventDefault();
                    console.log("Acc√®s au devtools bloqu√©.");
                }

                // If user is in a text input, don't control the video
                if (e.target === messageInput || e.target === codeInput) {
                    return;
                }

                // Video controls with keyboard
                switch(e.code) {
                    case 'Space':
                        e.preventDefault(); 
                        if (videoPlayer.src) { // Check if video is unlocked
                            togglePlayPause();
                            showControls();
                        }
                        break;
                    case 'ArrowRight':
                        if (videoPlayer.src) {
                            seek(10);
                            showControls();
                        }
                        break;
                    case 'ArrowLeft':
                        if (videoPlayer.src) {
                            seek(-10);
                            showControls();
                        }
                        break;
                }
            });

            // Handle unlocking the chat
            unlockChatButton.addEventListener('click', () => {
                codePopup.style.display = 'block';
                codeInput.focus();
                // Set the context for the chat password check
                submitCodeButton.dataset.target = 'chat';
            });
            
            // Handle unlocking the video
            unlockVideoButton.addEventListener('click', () => {
                codePopup.style.display = 'block';
                codeInput.focus();
                // Set the context for the video password check
                submitCodeButton.dataset.target = 'video';
            });

            // Handle closing the code popup
            closeCodePopup.addEventListener('click', () => {
                codePopup.style.display = 'none';
                codeError.classList.add('hidden');
                codeInput.value = '';
            });

            // Handle code submission
            const submitCode = () => {
                const target = submitCodeButton.dataset.target;
                const enteredCode = codeInput.value.trim();
                let correctCode = '';
                let loadingMessage = '';

                if (target === 'chat') {
                    correctCode = CHAT_ACCESS_CODE;
                    loadingMessage = "D√âCRYPTAGE DU CHAT...";
                } else if (target === 'video') {
                    correctCode = VIDEO_ACCESS_CODE;
                    loadingMessage = "ACC√àS AU FLUX VID√âO...";
                }

                if (enteredCode === correctCode) {
                    codePopup.style.display = 'none';
                    codeInput.value = '';
                    
                    // Show the new loading overlay
                    unlockLoadingText.textContent = loadingMessage;
                    unlockLoadingOverlay.style.display = 'flex';
                    
                    // Wait 3 seconds, then hide the overlay and unlock the content
                    setTimeout(() => {
                        unlockLoadingOverlay.style.display = 'none';

                        if (target === 'chat') {
                            chatInputContainer.classList.remove('locked');
                            chatInputContainer.classList.add('unlocked');
                            unlockChatButton.style.display = 'none';
                            messageInput.placeholder = "> ENVOYER UN MESSAGE...";
                            messageInput.focus();
                        } else if (target === 'video') {
                            // Check the video URL
                            const videoUrl = "https://non-existent-link.com/video.mp4"; // This link will fail
                            // For a working link, use:
                            // const videoUrl = "https://www.w3schools.com/html/mov_bbb.mp4";
                            
                            if (videoUrl && videoUrl.trim() !== '') {
                                videoLockOverlay.style.display = 'none';
                                videoPlayer.src = videoUrl;
                                // Add a listener to handle video loading errors gracefully
                                videoPlayer.addEventListener('error', () => {
                                    videoLockOverlay.style.display = 'flex';
                                    videoErrorOverlay.style.display = 'flex';
                                    videoControls.style.display = 'none';
                                    videoPlayer.style.display = 'none';
                                    unlockVideoButton.style.display = 'none';
                                });
                                // On successful load, display the video and its controls
                                videoPlayer.addEventListener('canplay', () => {
                                    videoPlayer.style.display = 'block';
                                    videoControls.style.display = 'flex';
                                    unlockVideoButton.style.display = 'none';
                                    videoLockOverlay.style.display = 'none';
                                    videoPlayer.play();
                                });
                                videoPlayer.load();
                            } else {
                                // If no video URL is provided, show the error message
                                videoLockOverlay.style.display = 'flex';
                                videoErrorOverlay.style.display = 'flex';
                                videoControls.style.display = 'none';
                                videoPlayer.style.display = 'none';
                                unlockVideoButton.style.display = 'none';
                            }
                        }
                    }, 3000); // 3-second loading time
                    
                } else {
                    codeError.classList.remove('hidden');
                    codeInput.value = '';
                }
            };

            submitCodeButton.addEventListener('click', submitCode);

            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitCode();
                }
            });

            // Handle sending messages with "Enter" key
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !chatInputContainer.classList.contains('locked')) {
                    const message = messageInput.value.trim();
                    if (message !== '') {
                        const newMessage = document.createElement('p');
                        newMessage.classList.add('flicker');
                        newMessage.innerHTML = `<span class="text-white">VOUS:</span> <span class="text-red-300">${message}</span>`;
                        chatMessages.appendChild(newMessage);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        messageInput.value = '';
                    }
                }
            });

            // Initialize the site
            startButton.addEventListener('click', () => {
                startScreen.style.display = 'none';
                loadingScreen.style.display = 'flex';
                
                // UPDATED: Shortened initial loading time to 3 seconds
                setTimeout(async () => {
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'flex';
                    
                    userIp = await getPublicIp();

                    // Launch processes
                    showScaryPopup();
                    addRandomSystemMessage(); // Start SYSTEM messages
                    addFakeUserMessage(); // Start fake user messages
                    updateFakeUserCount(); // Call it once to set initial value
                    userCountInterval = setInterval(updateFakeUserCount, 2000); // Update user count every 2 seconds
                    
                    // Prepare the hacking pop-up queue
                    // UPDATED: Durations are now 2 seconds max
                    popupsQueue = [
                        { title: "ANALYSE DE DONN√âES...", duration: 2000 },
                        { title: "ACC√àS AUX FICHIERS...", duration: 2000 },
                        { title: "BALAYAGE DES PORTS...", duration: 2000 },
                        { title: "D√âTECTION DE L'APPAREIL...", duration: 2000 },
                        { title: "R√âCUP√âRATION DES MOTS DE PASSE...", duration: 2000 },
                        { title: "ACC√àS AUX INFORMATIONS PERSONNELLES...", duration: 2000 }
                    ];
                    processPopupQueue();
                    
                }, 3000); // 3-second loading time
            });
        });
    </script>
</body>
</html>
